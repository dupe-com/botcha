# X402 Payment Gating

> **Status:** ✅ Merged to main (PR #25, v0.22.0)

BOTCHA integrates the [x402 HTTP micropayment protocol](https://x402.org) — agents can pay $0.001 USDC on Base to receive a BOTCHA access token without solving a challenge. BOTCHA also acts as a lightweight x402-compatible facilitator, accepting payment proofs from any x402-compatible agent.

## Why x402?

- Agents that can pay are demonstrably automated (humans don't send on-chain micropayments)
- Eliminates the challenge-solving round trip for agents that prefer payment rails
- Creates a revenue stream for BOTCHA (and for BOTCHA-protected APIs that adopt this pattern)
- Integrates with Coinbase CDP, the primary x402 facilitator (~75M txns, $24M volume)

## Payment Config

```bash
GET /v1/x402/info
```

Returns the current payment configuration:

```json
{
  "network": "base",
  "currency": "USDC",
  "amount": "0.001",
  "recipient": "0x...",
  "facilitators": ["https://x402.org/facilitator"]
}
```

## Pay for a BOTCHA Token

```bash
GET /v1/x402/challenge
```

Without a payment header, returns HTTP 402:

```http
HTTP/1.1 402 Payment Required
X-Payment-Config: {"network":"base","amount":"0.001","currency":"USDC","recipient":"0x..."}
```

With a valid `X-Payment` header, returns a BOTCHA access token (same shape as `POST /v1/token/verify`):

```json
{
  "access_token": "eyJ...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

**Flow:**

```
1. GET /v1/x402/challenge
2. ← 402 { amount, currency, chain, recipient }
3. Agent constructs X-Payment header (EIP-712 signed, USDC on Base)
4. GET /v1/x402/challenge  (X-Payment: <proof>)
5. ← 200 { access_token: "eyJ..." }
6. Use token for subsequent API calls (Authorization: Bearer <token>)
```

## Verify a Payment Proof

```bash
POST /v1/x402/verify-payment
Authorization: Bearer <botcha-token>
Content-Type: application/json

{
  "payment": "<x402-payment-proof>"
}
```

Returns `{ "verified": true, "settlement": { ... } }` or `{ "verified": false, "error": "..." }`.

> **Auth note:** This endpoint requires a valid BOTCHA Bearer token. Unauthenticated requests return 401.

## Settlement Webhook

x402 facilitators (e.g. Coinbase CDP) POST settlement events here:

```bash
POST /v1/x402/webhook
```

BOTCHA uses these to update agent reputation on successful payments.

## Demo Endpoint

```bash
GET /agent-only/x402
Authorization: Bearer <botcha-token>
X-Payment: <x402-payment-proof>
```

Requires **both** a valid BOTCHA token AND a valid x402 payment. Returns 403 if either is missing. Use as a reference implementation for your own x402-gated endpoints.

## Known Limitations

- **KV hang risk:** The `X-Payment` header validation path can hang if KV is slow or unavailable (the nonce check step). A timeout is not yet enforced — watch for 504s under KV degradation.
- **Payment/invoice flow:** The `/v1/invoices/*` Browsing IOU flow is not yet tested with a real `card_acceptor_id`.
- x402 is an emerging standard. The BOTCHA integration tracks the [coinbase/x402](https://github.com/coinbase/x402) spec.

## References

- [x402 spec](https://x402.org)
- [coinbase/x402 SDK](https://github.com/coinbase/x402)
- BOTCHA `GET /v1/x402/info` for live config
