name: PR Preview Cleanup

on:
  pull_request:
    branches: [main]
    types: [closed]

permissions:
  contents: read
  pull-requests: write

jobs:
  cleanup-preview:
    name: Delete Preview (PR #${{ github.event.pull_request.number }})
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          cd packages/cloudflare-workers
          bun install

      - name: Delete preview worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          workingDirectory: packages/cloudflare-workers
          command: delete botcha-pr-${{ github.event.pull_request.number }} --force
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        continue-on-error: true  # Worker may already be gone; don't fail the workflow

      - name: Post cleanup comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNum = context.payload.pull_request.number;
            const merged = context.payload.pull_request.merged;
            const action = merged ? 'merged' : 'closed';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNum,
              body: `ðŸ§¹ Preview worker \`botcha-pr-${prNum}\` deleted (PR ${action}).`
            });
